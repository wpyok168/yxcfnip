name: ğŸ”„ Auto Update Worker

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *"  # ğŸ• æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # ğŸ–ï¸ æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update:
    name: ğŸš€ åŒæ­¥å’Œä¼˜åŒ– Worker æ–‡ä»¶
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ åˆå§‹åŒ–ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ é…ç½® Git å’Œå®‰è£…ä¾èµ–
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false
          
          # å®‰è£…å·¥å…·
          echo "ğŸ“¦ å®‰è£… terser ä¸ javascript-obfuscator..."
          npm install -g terser javascript-obfuscator

      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
        id: check_files
        run: |
          echo "ğŸ” $(date '+%Y-%m-%d %H:%M:%S') - æ£€æŸ¥æ–‡ä»¶çŠ¶æ€..."
          
          if [[ -f "version.txt" ]]; then
            LOCAL_VERSION=$(cat version.txt)
            echo "âœ… version.txt å­˜åœ¨ï¼Œç‰ˆæœ¬: $LOCAL_VERSION"
            echo "HAS_VERSION=true" >> $GITHUB_ENV
          else
            echo "ğŸ“ version.txt ä¸å­˜åœ¨"
            echo "HAS_VERSION=false" >> $GITHUB_ENV
          fi
          
          # æ–‡ä»¶ç¼ºå¤±æ—¶å¼ºåˆ¶æ›´æ–°
          if [[ "$HAS_VERSION" == "false" || ! -f "source.js" || ! -f "_worker.js" ]]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤±ï¼Œéœ€è¦å¼ºåˆ¶æ›´æ–°"
            echo "FORCE_UPDATE=true" >> $GITHUB_ENV
          else
            echo "FORCE_UPDATE=false" >> $GITHUB_ENV
          fi

      - name: ğŸŒ è·å–è¿œç¨‹æ–‡ä»¶ä¿¡æ¯
        id: remote_info
        run: |
          echo "ğŸŒ $(date '+%Y-%m-%d %H:%M:%S') - æ­£åœ¨è·å–è¿œç¨‹æ–‡ä»¶..."
          RAW_URL="https://raw.githubusercontent.com/alienwaregf/CF-Worker-BestIP-collector-UI/refs/heads/main/_workers.js"
          
          for i in {1..3}; do
            echo "ğŸ” ç¬¬ $i æ¬¡å°è¯•è·å–è¿œç¨‹æ–‡ä»¶..."
            if curl -f -s -o /tmp/remote_worker.js "$RAW_URL"; then
              FILE_SIZE=$(stat -c%s /tmp/remote_worker.js 2>/dev/null || stat -f%z /tmp/remote_worker.js 2>/dev/null)
              if [[ $FILE_SIZE -gt 1000 ]]; then
                FILE_HASH=$(sha256sum /tmp/remote_worker.js | cut -d' ' -f1)
                echo "âœ… è¿œç¨‹æ–‡ä»¶è·å–æˆåŠŸï¼Œå¤§å°: $FILE_SIZE å­—èŠ‚ï¼Œå“ˆå¸Œ: ${FILE_HASH:0:16}..."
                echo "REMOTE_VERSION=$FILE_HASH" >> $GITHUB_ENV
                break
              fi
            fi
            
            if [[ $i -eq 3 ]]; then
              echo "âŒ è·å–è¿œç¨‹æ–‡ä»¶å¤±è´¥"
              exit 1
            fi
            sleep 5
          done

      - name: ğŸ“Š ç‰ˆæœ¬æ¯”å¯¹å’Œæ›´æ–°å†³ç­–
        id: update_decision
        run: |
          echo "ğŸ“Š $(date '+%Y-%m-%d %H:%M:%S') - ç‰ˆæœ¬æ¯”å¯¹å’Œæ›´æ–°å†³ç­–..."
          
          if [[ "$FORCE_UPDATE" == "true" ]]; then
            echo "ğŸ”„ æ–‡ä»¶ç¼ºå¤±ï¼Œå¼ºåˆ¶æ›´æ–°"
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          elif [[ -f "version.txt" ]]; then
            LOCAL_VERSION=$(cat version.txt)
            if [[ "$LOCAL_VERSION" == "$REMOTE_VERSION" ]]; then
              echo "ğŸ‰ ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°"
              echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            else
              echo "ğŸ”„ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°"
              echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            fi
          else
            echo "ğŸ”„ é¦–æ¬¡è¿è¡Œï¼Œéœ€è¦æ›´æ–°"
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          fi

      - name: â¬‡ï¸ ä¸‹è½½åŸå§‹æ–‡ä»¶
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "â¬‡ï¸ $(date '+%Y-%m-%d %H:%M:%S') - ä¿å­˜åŸå§‹æ–‡ä»¶..."
          cp /tmp/remote_worker.js source.js
          echo "âœ… source.js ä¿å­˜æˆåŠŸ"

      - name: ğŸ”§ ä»£ç æ··æ·†ä¸å‹ç¼©
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ”§ $(date '+%Y-%m-%d %H:%M:%S') - å¼€å§‹ä»£ç æ··æ·†ä¸å‹ç¼©..."

          # Step 1: terser é¢„å‹ç¼©
          echo "ğŸ› ï¸ ä½¿ç”¨ terser åˆæ­¥å‹ç¼©..."
          terser /tmp/remote_worker.js --compress --mangle --output /tmp/min_worker.js

          # Step 2: javascript-obfuscator æ··æ·†ï¼ˆæ–¹æ¡ˆ2ï¼‰
          echo "ğŸ§© ä½¿ç”¨ javascript-obfuscator æ··æ·†..."
          # javascript-obfuscator æ··æ·†ï¼ˆå·²ä¿®æ­£é€‰é¡¹åï¼‰
          javascript-obfuscator /tmp/min_worker.js --output _worker.js --compact true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-threshold 0.5 \
            --simplify true


          # Step 3: æ£€æŸ¥ç»“æœ
          if [[ -f "_worker.js" ]]; then
            COMPRESSED_SIZE=$(stat -c%s _worker.js 2>/dev/null || stat -f%z _worker.js 2>/dev/null)
            echo "ğŸ“ æ··æ·†åå¤§å°: $COMPRESSED_SIZE å­—èŠ‚"
          else
            echo "âŒ æ··æ·†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶"
            cp /tmp/remote_worker.js _worker.js
          fi

          # Step 4: ä½“ç§¯ä¸æ¯”ä¾‹æŠ¥å‘Š
          FINAL_SIZE=$(stat -c%s _worker.js 2>/dev/null || stat -f%z _worker.js 2>/dev/null)
          ORIGINAL_SIZE=$(stat -c%s source.js 2>/dev/null || stat -f%z source.js 2>/dev/null)
          COMPRESSION_RATIO=$(( (FINAL_SIZE * 100) / ORIGINAL_SIZE ))
          
          echo "ğŸ“Š å‹ç¼©æŠ¥å‘Š:"
          echo "   â€¢ åŸå§‹å¤§å°: $ORIGINAL_SIZE å­—èŠ‚"
          echo "   â€¢ æ··æ·†åå¤§å°: $FINAL_SIZE å­—èŠ‚"
          echo "   â€¢ å˜åŒ–æ¯”ä¾‹: $COMPRESSION_RATIO%"

          if [[ $FINAL_SIZE -gt 1048576 ]]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶è¶…è¿‡ 1MBï¼Œå¯èƒ½å½±å“ Cloudflare éƒ¨ç½²"
          fi

      - name: ğŸ“ æäº¤æ›´æ”¹
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ“ $(date '+%Y-%m-%d %H:%M:%S') - å‡†å¤‡æäº¤æ›´æ”¹..."
          echo "$REMOTE_VERSION" > version.txt
          git add source.js _worker.js version.txt
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          git commit -m "ğŸ”„ Auto Update Worker

          â€¢ åŒæ­¥æœ€æ–° Worker æ–‡ä»¶ï¼ˆæ··æ·†ç‰ˆï¼‰
          â€¢ ç‰ˆæœ¬: ${REMOTE_VERSION:0:16}...
          â€¢ æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æäº¤å®Œæˆ"

      - name: ğŸ‰ æ›´æ–°å®Œæˆ
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "ğŸ‰ $(date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨æ›´æ–°å®Œæˆï¼"
          echo "::notice title=æ›´æ–°å®Œæˆ::å·²æˆåŠŸåŒæ­¥ã€å‹ç¼©å¹¶æ··æ·†ä»£ç "

      - name: ğŸ˜´ æ— éœ€æ›´æ–°
        if: env.UPDATE_NEEDED == 'false'
        run: |
          echo "ğŸ˜´ $(date '+%Y-%m-%d %H:%M:%S') - å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"

  cleanup:
    name: ğŸ§¹ æ¸…ç†å·¥ä½œæµè®°å½•
    runs-on: ubuntu-latest
    needs: update
    permissions:
      actions: write
      contents: read
    if: always()
    steps:
      - name: ğŸ—‘ï¸ åˆ é™¤æ—§å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 3
          keep_minimum_runs_per_workflow: 2

      - name: ğŸ“Š æ¸…ç†å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ§¹ å·¥ä½œæµæ¸…ç†å®Œæˆ"
          echo "::notice title=æ¸…ç†å®Œæˆ::å·²æ¸…ç†æ—§è¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€è¿‘3æ¬¡"
